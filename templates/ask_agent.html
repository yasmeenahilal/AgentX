<!-- templates/ask_agent.html -->
{% extends "base.html" %}

{% block title %}Ask Agent{% endblock %}
{% set active_page = 'ask_agent' %}

{% block content %}
<div class="flex h-[calc(100vh-130px)] w-full mx-auto bg-gray-50 border border-gray-200" style="height: 77vh;">

    <!-- Chat Session Sidebar -->
    <div class="w-64 flex flex-col bg-gray-100 border-r border-gray-200 overflow-y-auto">
        <div class="p-4 border-b border-gray-200">
            <button id="new-chat-btn" class="w-full inline-flex justify-center items-center rounded-md border border-transparent bg-indigo-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed">
                <svg class="-ml-1 mr-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                    <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                </svg>
                New Chat
            </button>
        </div>
        <div class="flex-1 p-2 space-y-1 truncate w-40">
            <h3 class="px-2 text-xs font-semibold text-gray-500 uppercase tracking-wider">Chat History</h3>
            <ul id="session-list" class="space-y-1">
                <!-- Session links will be populated here -->
                 <li class="px-2 py-1 text-sm text-gray-500">Select an agent first.</li>
            </ul>
        </div>
    </div>

    <!-- Main Chat Area -->
    <div class="flex-1 flex flex-col bg-white shadow sm:rounded-lg overflow-hidden">
        <!-- Chat Header with Agent Selection -->
        <div class="px-4 py-3 border-b border-gray-200 bg-gray-50 flex items-center">
            <div class="flex-1">
                <div class="flex gap-3 items-center">
                     <label for="agent_name" class="text-sm font-medium text-gray-700">Agent:</label>
                    <select id="agent_name" name="agent_name" class="form-select bg-white text-gray-900 rounded-md border-0 py-1.5 px-3 text-sm shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-indigo-600">
                         <option value="" disabled selected>Select Agent</option>
                    </select>
                    <input type="hidden" id="user_id" name="user_id">
                     <input type="hidden" id="agent_id" name="agent_id">
                </div>
            </div>
        </div>

        <!-- Chat Messages Area -->
        <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-6 bg-white scroll-smooth">
             <div class="chat-message agent-message">
                 <div class="flex items-start">
                     <div class="flex-shrink-0 mr-3">
                         <div class="h-8 w-8 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600">
                             <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09z" /></svg>
                         </div>
                     </div>
                     <div id="initial-response-box" class="flex-1 bg-gray-100 p-4 rounded-lg rounded-tl-none shadow text-gray-800 max-w-3xl">
                         <p>Select an agent to start chatting.</p>
                     </div>
                 </div>
             </div>
        </div>

        <!-- Input Area -->
        <div class="border-t border-gray-200 bg-gray-50 px-4 py-3">
            <div class="relative">
                <div class="flex items-end gap-2">
                    <div class="flex-1 min-w-0 relative">
                        <textarea id="question" name="question" rows="1" required disabled 
                                 class="form-textarea block w-full rounded-lg border-0 bg-white py-2 pl-3 pr-10 text-gray-900 placeholder:text-gray-400 resize-none ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-indigo-600 text-sm shadow-sm disabled:bg-gray-100"
                                 placeholder="Select an agent first..."
                                 oninput="this.style.height = 'auto'; this.style.height = (this.scrollHeight) + 'px';"
                                 style="min-height: 42px; max-height: 200px;"></textarea>
                    </div>
                    <button type="button" id="ask-btn" disabled 
                            class="inline-flex items-center justify-center rounded-full bg-indigo-600 p-2 text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600 transition duration-150 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed">
                        <span id="btn-text">Ask</span>
                        <span id="spinner" class="ml-2 hidden">
                            <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </span> 
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast Notification Container -->
<div id="toast-container" ...></div>

<style>
/* ... existing styles ... */
.session-link {
    @apply block w-full text-left px-3 py-2 text-sm text-gray-700 rounded-md hover:bg-gray-100 hover:text-gray-900 truncate cursor-pointer;
}
.session-link.active {
    @apply bg-indigo-50 text-indigo-700 font-medium;
}
/* Styles for chat bubbles */
.chat-message { @apply max-w-xl mb-4 clear-both; }
.user-message { @apply float-right; }
.agent-message { @apply float-left; }
.user-message > div { @apply ml-auto bg-indigo-600 text-white rounded-lg rounded-br-none p-3 shadow; }
.agent-message > div { @apply mr-auto bg-gray-100 text-gray-800 rounded-lg rounded-bl-none p-3 shadow; }

</style>

<script>
 // State variables
 let currentAgentId = null; 
 let currentAgentName = null; 
 let currentUserId = null; 
 let currentSessionId = null;
 let availableAgents = []; 

 // DOM Elements
 const agentSelect = document.getElementById('agent_name');
 const agentIdInput = document.getElementById('agent_id');
 const userIdInput = document.getElementById('user_id');
 const questionInput = document.getElementById('question');
 const askBtn = document.getElementById('ask-btn');
 const btnText = document.getElementById('btn-text');
 const spinner = document.getElementById('spinner');
 const chatContainer = document.getElementById('chat-container');

 // --- Utility Functions ---
 function showToast(message, type = 'success') { /* ... existing toast function ... */ }

 function appendMessage(type, content) {
     const messageDiv = document.createElement('div');
     messageDiv.classList.add('chat-message', type === 'human' ? 'user-message' : 'agent-message');

     const contentDiv = document.createElement('div');
     // Basic parsing for newlines, potential for markdown later
     contentDiv.innerHTML = content.replace(/\n/g, '<br>');

     messageDiv.appendChild(contentDiv);
     chatContainer.appendChild(messageDiv);
     // Scroll to bottom
     chatContainer.scrollTop = chatContainer.scrollHeight;
 }

 function clearChatArea(showInitialMessage = false) {
     chatContainer.innerHTML = ''; 
     if (showInitialMessage) {
         // Add back the initial prompt message
         const initialMsgDiv = document.createElement('div');
         initialMsgDiv.classList.add('chat-message', 'agent-message');
         initialMsgDiv.innerHTML = `
              <div class="flex items-start">
                 <div class="flex-shrink-0 mr-3">
                      <div class="h-8 w-8 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600">
                           <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09z" /></svg>
                      </div>
                  </div>
                  <div class="flex-1 bg-gray-100 p-4 rounded-lg rounded-tl-none shadow text-gray-800 max-w-3xl">
                       <p>Select an agent to start chatting, or choose a previous chat session.</p>
                   </div>
               </div>`;
         chatContainer.appendChild(initialMsgDiv);
     }
 }

 function enableChatInput() {
     console.log("Executing enableChatInput() called.");
     questionInput.disabled = false;
     askBtn.disabled = false;
     questionInput.placeholder = "Message...";
 }

 function disableChatInput() {
     questionInput.disabled = true;
     askBtn.disabled = true;
     questionInput.placeholder = "Select an agent first...";
 }

 // --- NEW: Style Functions ---
 function setActiveSessionLink(sessionId) {
     document.querySelectorAll('#session-list .session-link').forEach(link => {
         link.classList.remove('active');
         if (link.dataset.sessionId === String(sessionId)) {
             link.classList.add('active');
         }
     });
 }

 // --- Core Functions ---

 async function loadAvailableAgents() {
     console.log("Loading available agents...");
     try {
         // Use the existing list_agents endpoint (or /agent/all if preferred)
         const response = await fetch(`/agent/list_agents`, {
             headers: { 'Authorization': `Bearer ${localStorage.getItem('access_token')}` },
             credentials: 'include'
         });
         if (!response.ok) throw new Error(`Failed to load agents: ${response.status}`);
         const data = await response.json();

         availableAgents = data.agents.map(agent => ({ id: agent.id, name: agent.agent_name })); // Assuming response has id and agent_name
         console.log("Available agents:", availableAgents);

         agentSelect.innerHTML = '<option value="" disabled selected>Select Agent</option>'; // Reset options
         availableAgents.forEach(agent => {
             const option = document.createElement('option');
             option.value = agent.name; // Use name for selection value
             option.textContent = agent.name;
             option.dataset.agentId = agent.id; // Store DB ID in data attribute
             agentSelect.appendChild(option);
         });
         // Clear session list when loading agents
         document.getElementById('session-list').innerHTML = '<li class="px-2 py-1 text-sm text-gray-500">Select an agent first.</li>';
         currentSessionId = null; // Reset session when agent list reloads
         setActiveSessionLink(null);
         clearChatArea(true); // Clear chat and show initial message
         disableChatInput();
     } catch (error) {
         console.error('Error loading agents:', error);
         showToast('Failed to load agents.', 'error');
         disableChatInput();
     }
 }

 // --- NEW: Load/Display Sessions and Messages ---
 async function loadChatSessions(agentId) {
     if (!agentId || !currentUserId) {
         console.log("Cannot load sessions without agentId or userId");
         return;
     }
     const sessionList = document.getElementById('session-list');
     sessionList.innerHTML = '<li class="px-2 py-1 text-sm text-gray-500">Loading sessions...</li>'; // Loading indicator

     try {
         const response = await fetch(`/chat/sessions/${agentId}`, {
             headers: { 'Authorization': `Bearer ${localStorage.getItem('access_token')}` },
             credentials: 'include'
         });
         if (!response.ok) throw new Error(`Failed to load sessions: ${response.status}`);
         const sessions = await response.json();
         console.log(`Loaded ${sessions.length} sessions for agent ${agentId}`);

         sessionList.innerHTML = ''; // Clear loading/previous sessions
         if (sessions.length === 0) {
             sessionList.innerHTML = '<li class="px-2 py-1 text-sm text-gray-500">No chat history.</li>';
         } else {
             sessions.forEach(session => {
                 const li = document.createElement('li');
                 const button = document.createElement('button');
                 button.classList.add('session-link');
                 button.dataset.sessionId = session.id;
                 button.textContent = session.title || `Session ${session.id}`;
                 button.title = session.title || `Session ${session.id}`; // Tooltip for long titles
                 li.appendChild(button);
                 sessionList.appendChild(li);
             });
         }
     } catch (error) {
         console.error('Error loading chat sessions:', error);
         sessionList.innerHTML = '<li class="px-2 py-1 text-sm text-red-500">Error loading sessions.</li>';
         showToast('Failed to load chat history.', 'error');
     }
 }

 async function loadChatMessages(sessionId) {
     if (!sessionId || !currentUserId) {
          console.log("Cannot load messages without sessionId or userId");
          return;
      }
     console.log(`Loading messages for session: ${sessionId}`);
     clearChatArea(); // Clear before loading
     appendMessage('ai', 'Loading history...'); // Loading indicator in chat

     try {
         const response = await fetch(`/chat/messages/${sessionId}`, {
              headers: { 'Authorization': `Bearer ${localStorage.getItem('access_token')}` },
              credentials: 'include'
         });
         if (!response.ok) throw new Error(`Failed to load messages: ${response.status}`);
         const messages = await response.json();
         console.log(`Loaded ${messages.length} messages for session ${sessionId}`);

         clearChatArea(); // Clear loading message
         if (messages.length === 0) {
              appendMessage('ai', 'No messages in this session yet.');
         } else {
             messages.forEach(msg => {
                  // Use the message_type from the response ('human' or 'ai')
                  appendMessage(msg.message_type, msg.content);
              });
          }
         enableChatInput(); // Enable input after loading history
         questionInput.focus();
     } catch (error) {
         console.error('Error loading chat messages:', error);
         clearChatArea();
         appendMessage('ai', `<span class="text-red-500">Error loading messages for this session.</span>`);
         showToast('Failed to load chat messages.', 'error');
         disableChatInput(); // Disable input on error
     }
 }

 // --- Event Listeners ---

 agentSelect.addEventListener('change', async (e) => {
     currentAgentName = e.target.value;
     const selectedOption = e.target.options[e.target.selectedIndex];
     currentAgentId = selectedOption.dataset.agentId ? parseInt(selectedOption.dataset.agentId) : null;

     console.log(`Agent selected: Name=${currentAgentName}, ID=${currentAgentId}`);
     agentIdInput.value = currentAgentId || ''; 

     if (currentAgentId) {
         clearChatArea(); // Clear chat when agent changes
         currentSessionId = null; // Reset session ID
         setActiveSessionLink(null);
         // Maybe load history from session here if desired using the new endpoint
         // For now, just enable input
         appendMessage('ai', `Selected agent: <strong>${currentAgentName}</strong>. Start a new chat or select one from the history.`);
         await loadChatSessions(currentAgentId); // Load sessions for the selected agent
         enableChatInput(); 
         questionInput.focus();
     } else {
         document.getElementById('session-list').innerHTML = '<li class="px-2 py-1 text-sm text-gray-500">Select an agent first.</li>';
         disableChatInput();
     }
 });

 // --- NEW: Session List Click Handler (Event Delegation) ---
 document.getElementById('session-list').addEventListener('click', async (e) => {
     if (e.target && e.target.matches('button.session-link')) {
         const selectedSessionId = parseInt(e.target.dataset.sessionId);
         console.log("Session link clicked:", selectedSessionId);
         if (selectedSessionId && selectedSessionId !== currentSessionId) {
              currentSessionId = selectedSessionId;
              setActiveSessionLink(currentSessionId);
              await loadChatMessages(currentSessionId);
         }
     }
 });

 // --- NEW: New Chat Button Handler ---
 document.getElementById('new-chat-btn').addEventListener('click', () => {
     if (!currentAgentId) {
         showToast("Please select an agent first.", "warning");
         return;
     }
     console.log("New Chat button clicked");
     currentSessionId = null; // Clear the current session ID
     setActiveSessionLink(null); // Deselect session link in UI
     clearChatArea(); // Clear the chat display area
     appendMessage('ai', `Started a new chat with <strong>${currentAgentName}</strong>.`); // Give feedback
     enableChatInput();
     questionInput.focus();
 });

 askBtn.addEventListener('click', async () => {
      const question = questionInput.value.trim();
      if (!question || !currentAgentName || !currentUserId) {
          showToast('Agent and Question are required.', 'error');
          return;
      }

      appendMessage('human', question);
      questionInput.value = ''; 
      questionInput.style.height = '42px';

      askBtn.disabled = true;
      btnText.textContent = 'Thinking...';
      spinner.classList.remove('hidden');

      // UPDATE: Include session_id if it exists
      const requestPayload = { 
          question: question,
          session_id: currentSessionId // Pass currentSessionId (will be null for new chats)
      };

       // Logging before fetch (can keep)
       const url = `${window.API_BASE_URL}/agent/${currentAgentName}/query`;
       const token = localStorage.getItem('access_token');
       const requestBody = JSON.stringify(requestPayload);
       console.log('--- Preparing Fetch ---');
       console.log('Target URL:', url);
       console.log('Token:', token);
       console.log('Request Body:', requestBody);
       console.log('Credentials Setting:', 'include');

      try {
          const response = await fetch(url, {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${token}`
              },
              credentials: 'include',
              body: requestBody
          });
           console.log('Fetch response object received:', response);

          if (!response.ok) {
              // ... (error handling remains the same) ...
              const errorText = await response.text();
              console.error('HTTP error! Status:', response.status, 'Response Text:', errorText);
              let userFriendlyMessage = `Request failed with status ${response.status}.`;
              try { const errorJson = JSON.parse(errorText); if (errorJson.detail) userFriendlyMessage = errorJson.detail; } catch(e) { /* Ignore */ }
              appendMessage('ai', `<span class="text-red-500">Error: ${userFriendlyMessage}</span>`);
              showToast(userFriendlyMessage, 'error');
              return; 
          }

          // UPDATE: Response now includes session_id as well { answer: "...", session_id: ... }
          const data = await response.json();
           console.log('API Response Data:', data);
           appendMessage('ai', data.answer || 'Received empty answer.');

           // --- Session Handling ---
           const returnedSessionId = data.session_id;
           if (returnedSessionId && currentSessionId !== returnedSessionId) {
                console.log(`Session ID updated/created: ${returnedSessionId}`);
                const isNewSession = !currentSessionId; // Check if it was a new chat
                currentSessionId = returnedSessionId; // Update state
                // If it was a new session, refresh the session list to show it
                if (isNewSession && currentAgentId) {
                     await loadChatSessions(currentAgentId); // Reload session list
                     // Highlight the newly created session after list reloads (slight delay might be needed)
                     setTimeout(() => setActiveSessionLink(currentSessionId), 300);
                 } else {
                    // If just continuing an existing session, ensure it's highlighted
                     setActiveSessionLink(currentSessionId);
                 }
           }
           // --- End Session Handling ---

      } catch (error) {
          console.error('Fetch error caught:', error);
          let displayMessage = "Request failed. Check network or server.";
          appendMessage('ai', `<span class="text-red-500">Error: ${displayMessage}</span>`);
          showToast(displayMessage, 'error');
      } finally {
          // Re-enable button
          askBtn.disabled = false;
          btnText.textContent = 'Ask';
          spinner.classList.add('hidden');
          questionInput.focus(); // Focus input again
      }
 });

 // Submit with Enter key (Shift+Enter for newline)
 questionInput.addEventListener('keydown', function(event) {
     if (event.key === 'Enter' && !event.shiftKey) {
         event.preventDefault();
         if (!askBtn.disabled) {
             askBtn.click();
         }
     }
 });

 // Initial Setup on Load
 document.addEventListener('DOMContentLoaded', async () => {
     console.log('Chat History DOMContentLoaded fired.');
     // Get user ID from local storage (assuming it's stored after login)
     currentUserId = localStorage.getItem('user_id');
     if (currentUserId) {
         userIdInput.value = currentUserId; // Set hidden input
         console.log(`User ID found: ${currentUserId}`);
         await loadAvailableAgents(); // Load agents now that we have user ID
     } else {
         console.error("User ID not found in localStorage. Cannot load agents or chats.");
         showToast("Login session issue: User ID not found.", "error");
         // Optionally redirect to login
     }

     // Define API Base URL (adjust if needed)
     window.API_BASE_URL = window.location.origin; // Assumes backend is at same origin
     console.log(`API Base URL set to: ${window.API_BASE_URL}`);

     disableChatInput(); // Start with input disabled

 });

</script>
{% endblock %}