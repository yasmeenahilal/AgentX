<!-- templates/ask_agent.html -->
{% extends "base.html" %}

{% block title %}Ask Agent{% endblock %}
{% set active_page = 'ask_agent' %}

{% block content %}
<div class="flex h-[calc(100vh-130px)] w-full mx-auto bg-gray-50 border border-gray-200" style="height: 77vh;">

    <!-- Sidebar for Chat Sessions -->
    <div class="w-1/4 border-r border-gray-200 bg-white flex flex-col">
        <div class="p-4 border-b border-gray-200">
            <button id="new-chat-btn" class="w-full inline-flex justify-center items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                </svg>
                New Chat
            </button>
        </div>
        <div class="flex-1 overflow-y-auto p-2 space-y-1" id="chat-session-list">
            <!-- Chat session links will be loaded here -->
            <p class="text-center text-gray-500 text-sm mt-4">Loading chats...</p>
        </div>
         <div class="p-2 border-t border-gray-100 text-center text-xs text-gray-400">
            Agent: <span id="current-agent-name-display">None</span>
        </div>
    </div>

    <!-- Main Chat Area -->
    <div class="flex-1 flex flex-col bg-white shadow sm:rounded-lg overflow-hidden">
        <!-- Chat Header with Agent Selection -->
        <div class="px-4 py-3 border-b border-gray-200 bg-gray-50 flex items-center">
            <div class="flex-1">
                <div class="flex gap-3 items-center">
                     <label for="agent_name" class="text-sm font-medium text-gray-700">Agent:</label>
                    <select id="agent_name" name="agent_name" class="form-select bg-white text-gray-900 rounded-md border-0 py-1.5 px-3 text-sm shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-indigo-600">
                         <!-- Agents will be loaded here -->
                         <option value="" disabled selected>Select Agent</option>
                    </select>
                    <input type="hidden" id="user_id" name="user_id"> <!-- Keep hidden user_id -->
                     <input type="hidden" id="agent_id" name="agent_id"> <!-- Hidden agent_id -->
                </div>
            </div>
        </div>

        <!-- Chat Messages Area -->
        <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-6 bg-white scroll-smooth">
             <div class="chat-message agent-message">
                 <div class="flex items-start">
                     <div class="flex-shrink-0 mr-3">
                         <div class="h-8 w-8 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600">
                             <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09z" /></svg>
                         </div>
                     </div>
                     <div id="initial-response-box" class="flex-1 bg-gray-100 p-4 rounded-lg rounded-tl-none shadow text-gray-800 max-w-3xl">
                         <p>Select an agent to start chatting.</p>
                     </div>
                 </div>
             </div>
            <!-- Messages will be appended here -->
        </div>

        <!-- Input Area -->
        <div class="border-t border-gray-200 bg-gray-50 px-4 py-3">
            <div class="relative">
                <div class="flex items-end gap-2">
                    <div class="flex-1 min-w-0 relative">
                        <textarea id="question" name="question" rows="1" required disabled 
                                 class="form-textarea block w-full rounded-lg border-0 bg-white py-2 pl-3 pr-10 text-gray-900 placeholder:text-gray-400 resize-none ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-indigo-600 text-sm shadow-sm disabled:bg-gray-100"
                                 placeholder="Select an agent first..."
                                 oninput="this.style.height = 'auto'; this.style.height = (this.scrollHeight) + 'px';"
                                 style="min-height: 42px; max-height: 200px;"></textarea>
                    </div>
                    <button type="button" id="ask-btn" disabled 
                            class="inline-flex items-center justify-center rounded-full bg-indigo-600 p-2 text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600 transition duration-150 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed">
                        <span id="btn-text">Ask</span>
                        <span id="spinner" class="ml-2 hidden">
                            <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </span> 
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast Notification Container -->
<div id="toast-container" ...></div>

<style>
/* ... existing styles ... */
.session-link {
    @apply block w-full text-left px-3 py-2 text-sm text-gray-700 rounded-md hover:bg-gray-100 hover:text-gray-900 truncate cursor-pointer;
}
.session-link.active {
    @apply bg-indigo-50 text-indigo-700 font-medium;
}
/* Styles for chat bubbles */
.chat-message { @apply max-w-xl mb-4 clear-both; }
.user-message { @apply float-right; }
.agent-message { @apply float-left; }
.user-message > div { @apply ml-auto bg-indigo-600 text-white rounded-lg rounded-br-none p-3 shadow; }
.agent-message > div { @apply mr-auto bg-gray-100 text-gray-800 rounded-lg rounded-bl-none p-3 shadow; }

</style>

<script>
 // State variables
 let currentSessionId = null;
 let currentAgentId = null; // Store the DB ID of the selected agent
 let currentAgentName = null; // Store the name of the selected agent
 let currentUserId = null; // Store the user's DB ID
 let availableAgents = []; // Store list of available agents {id, name}

 // DOM Elements
 const agentSelect = document.getElementById('agent_name');
 const agentIdInput = document.getElementById('agent_id');
 const userIdInput = document.getElementById('user_id');
 const questionInput = document.getElementById('question');
 const askBtn = document.getElementById('ask-btn');
 const btnText = document.getElementById('btn-text');
 const spinner = document.getElementById('spinner');
 const chatContainer = document.getElementById('chat-container');
 const sessionListContainer = document.getElementById('chat-session-list');
 const newChatBtn = document.getElementById('new-chat-btn');
 const agentNameDisplay = document.getElementById('current-agent-name-display');


 // --- Utility Functions ---
 function showToast(message, type = 'success') { /* ... existing toast function ... */ }

 function appendMessage(type, content) {
     const messageDiv = document.createElement('div');
     messageDiv.classList.add('chat-message', type === 'human' ? 'user-message' : 'agent-message');

     const contentDiv = document.createElement('div');
     // Basic parsing for newlines, potential for markdown later
     contentDiv.innerHTML = content.replace(/\n/g, '<br>');

     messageDiv.appendChild(contentDiv);
     chatContainer.appendChild(messageDiv);
     // Scroll to bottom
     chatContainer.scrollTop = chatContainer.scrollHeight;
 }

 function clearChatArea() {
     // Remove all but the initial message box (if desired)
     // chatContainer.innerHTML = ''; // Or keep the initial welcome message
     const initialBox = document.getElementById('initial-response-box');
      chatContainer.innerHTML = ''; // Clear everything for now
     if (initialBox) {
         // Re-add a generic welcome/instruction message if needed
         // chatContainer.appendChild(initialBox.cloneNode(true));
         appendMessage('ai', 'Select a chat or start a new one.');
     }
 }

 function enableChatInput() {
     console.log("Executing enableChatInput() called.");
     questionInput.disabled = false;
     askBtn.disabled = false;
     questionInput.placeholder = "Message...";
 }

 function disableChatInput() {
     questionInput.disabled = false;
     askBtn.disabled = false;
     questionInput.placeholder = "Select an agent first...";
 }

 // --- Core Functions ---

 async function loadAvailableAgents() {
     console.log("Loading available agents...");
     try {
         // Use the existing list_agents endpoint (or /agent/all if preferred)
         const response = await fetch(`/agent/list_agents`, {
             headers: { 'Authorization': `Bearer ${localStorage.getItem('access_token')}` },
             credentials: 'include'
         });
         if (!response.ok) throw new Error(`Failed to load agents: ${response.status}`);
         const data = await response.json();

         availableAgents = data.agents.map(agent => ({ id: agent.id, name: agent.agent_name })); // Assuming response has id and agent_name
         console.log("Available agents:", availableAgents);

         agentSelect.innerHTML = '<option value="" disabled selected>Select Agent</option>'; // Reset options
         availableAgents.forEach(agent => {
             const option = document.createElement('option');
             option.value = agent.name; // Use name for selection value
             option.textContent = agent.name;
             option.dataset.agentId = agent.id; // Store DB ID in data attribute
             agentSelect.appendChild(option);
         });
     } catch (error) {
         console.error('Error loading agents:', error);
         showToast('Failed to load agents.', 'error');
         disableChatInput();
     }
 }

 async function loadChatSessions(agentId) {
     if (!currentUserId || !agentId) return;
     console.log(`Loading sessions for user ${currentUserId}, agent ${agentId}`);
     sessionListContainer.innerHTML = '<p class="text-center text-gray-500 text-sm mt-4">Loading chats...</p>'; // Show loading state

     try {
         const response = await fetch(`/chat/sessions/${agentId}`, { // Use agent ID in URL
             headers: { 'Authorization': `Bearer ${localStorage.getItem('access_token')}` },
             credentials: 'include'
         });
         if (!response.ok) throw new Error(`Failed to load sessions: ${response.status}`);
         const sessions = await response.json();

         sessionListContainer.innerHTML = ''; // Clear loading/previous list
         if (sessions.length === 0) {
             sessionListContainer.innerHTML = '<p class="text-center text-gray-500 text-sm mt-4">No past chats.</p>';
         } else {
             sessions.forEach(session => {
                 const link = document.createElement('a');
                 link.href = '#';
                 link.classList.add('session-link');
                 link.textContent = session.title || `Chat from ${new Date(session.created_at).toLocaleDateString()}`;
                 link.dataset.sessionId = session.id;
                 link.onclick = (e) => {
                     e.preventDefault();
                     handleSessionClick(session.id);
                 };
                 sessionListContainer.appendChild(link);
             });
         }
         // Highlight the active session if one is selected
         highlightActiveSession();

     } catch (error) {
         console.error('Error loading chat sessions:', error);
         sessionListContainer.innerHTML = '<p class="text-center text-red-500 text-sm mt-4">Error loading chats.</p>';
         showToast('Failed to load chat sessions.', 'error');
     }
 }

 async function loadChatMessages(sessionId) {
     if (!sessionId) return;
     console.log(`Loading messages for session: ${sessionId}`);
     clearChatArea(); // Clear previous messages

     try {
         const response = await fetch(`/chat/messages/${sessionId}`, {
             headers: { 'Authorization': `Bearer ${localStorage.getItem('access_token')}` },
             credentials: 'include'
         });
         if (!response.ok) throw new Error(`Failed to load messages: ${response.status}`);
         const messages = await response.json();

         messages.forEach(msg => {
             appendMessage(msg.message_type, msg.content);
         });
         enableChatInput(); // Enable input after loading history
     } catch (error) {
         console.error('Error loading chat messages:', error);
         appendMessage('ai', `<span class="text-red-500">Error loading messages for this chat.</span>`);
         showToast('Failed to load chat messages.', 'error');
         disableChatInput(); // Disable if loading fails
     }
 }

 function startNewChat() {
     console.log("Executing startNewChat()...");
     currentSessionId = null;
     console.log("Cleared session ID. Current Agent ID:", currentAgentId);
     clearChatArea();
     appendMessage('ai', 'Started a new chat. Ask me anything!');
     highlightActiveSession(); // Deselect any active session link
     if (currentAgentId) {
         enableChatInput(); // Enables input
         questionInput.focus();
     } else {
         disableChatInput();
     }
 }

 function handleSessionClick(sessionId) {
     console.log(`Session clicked: ${sessionId}`);
     currentSessionId = sessionId;
     loadChatMessages(sessionId);
     highlightActiveSession();
     questionInput.focus();
 }

 function highlightActiveSession() {
      // Remove active class from all links
      sessionListContainer.querySelectorAll('.session-link').forEach(link => {
          link.classList.remove('active');
      });
      // Add active class to the current session link
      if (currentSessionId) {
          const activeLink = sessionListContainer.querySelector(`.session-link[data-session-id="${currentSessionId}"]`);
          if (activeLink) {
              activeLink.classList.add('active');
          }
      }
  }


 // --- Event Listeners ---

 agentSelect.addEventListener('change', async (e) => {
     currentAgentName = e.target.value;
     const selectedOption = e.target.options[e.target.selectedIndex];
     currentAgentId = selectedOption.dataset.agentId ? parseInt(selectedOption.dataset.agentId) : null; // Get agent DB ID

     console.log(`Agent selected: Name=${currentAgentName}, ID=${currentAgentId}`);
     agentIdInput.value = currentAgentId || ''; // Update hidden input
     agentNameDisplay.textContent = currentAgentName || 'None'; // Update display

     if (currentAgentId) {
         startNewChat(); // Start a new chat by default when agent changes
         await loadChatSessions(currentAgentId); // Load sessions for the new agent
     } else {
         disableChatInput();
         sessionListContainer.innerHTML = '<p class="text-center text-gray-500 text-sm mt-4">Select an agent.</p>';
     }
 });

 newChatBtn.addEventListener('click', startNewChat);

 askBtn.addEventListener('click', async () => {
      const question = questionInput.value.trim();
      if (!question || !currentAgentName || !currentUserId) {
          showToast('Agent and Question are required.', 'error');
          return;
      }

      appendMessage('human', question); // Display user message immediately
      questionInput.value = ''; // Clear input
      questionInput.style.height = '42px'; // Reset height

      // Disable button during processing
      askBtn.disabled = true;
      btnText.textContent = 'Thinking...';
      spinner.classList.remove('hidden');

      const requestPayload = {
          question: question,
          session_id: currentSessionId // Send currentSessionId (null if new chat)
      };

       // --- Detailed logging before fetch ---
       const url = `${window.API_BASE_URL}/agent/${currentAgentName}/query`;
       const token = localStorage.getItem('access_token');
       const requestBody = JSON.stringify(requestPayload);
       console.log('--- Preparing Fetch ---');
       console.log('Target URL:', url);
       console.log('Token:', token);
       console.log('Request Body:', requestBody);
       console.log('Credentials Setting:', 'include');
       // ---

      try {
          const response = await fetch(url, {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${token}`
              },
              credentials: 'include',
              body: requestBody
          });

           console.log('Fetch response object received:', response);

          if (!response.ok) {
               // ... (existing detailed error handling based on response.status and text) ...
               const errorText = await response.text();
               console.error('HTTP error! Status:', response.status, 'Response Text:', errorText);
               let userFriendlyMessage = `Request failed with status ${response.status}.`;
                 try { // Try parsing server error detail
                     const errorJson = JSON.parse(errorText);
                     if (errorJson.detail) userFriendlyMessage = errorJson.detail;
                 } catch(e) { /* Ignore if not JSON */ }
               appendMessage('ai', `<span class="text-red-500">Error: ${userFriendlyMessage}</span>`);
               showToast(userFriendlyMessage, 'error');
               // throw new Error(`HTTP error ${response.status}`); // No need to throw if displaying
               return; // Stop processing on error
          }

          const data = await response.json(); // Should contain { answer: "...", session_id: ... }
          console.log('API Response Data:', data);

          appendMessage('ai', data.answer || 'Received empty answer.');

          // If it was a new chat, the response gives us the new session ID
          if (!currentSessionId && data.session_id) {
              currentSessionId = data.session_id;
              console.log(`New session started, ID: ${currentSessionId}`);
              // Reload chat sessions to show the new one
              await loadChatSessions(currentAgentId);
              highlightActiveSession(); // Highlight the new session
          }

      } catch (error) {
          console.error('Fetch error caught:', error);
          let displayMessage = "Request failed. Check network or server.";
          appendMessage('ai', `<span class="text-red-500">Error: ${displayMessage}</span>`);
          showToast(displayMessage, 'error');
      } finally {
          // Re-enable button
          askBtn.disabled = false;
          btnText.textContent = 'Ask';
          spinner.classList.add('hidden');
          questionInput.focus(); // Focus input again
      }
 });


 // Submit with Enter key (Shift+Enter for newline)
 questionInput.addEventListener('keydown', function(event) {
     if (event.key === 'Enter' && !event.shiftKey) {
         event.preventDefault();
         if (!askBtn.disabled) {
             askBtn.click();
         }
     }
 });

 // Initial Setup on Load
 document.addEventListener('DOMContentLoaded', async () => {
     console.log('Chat History DOMContentLoaded fired.');
     // Get user ID from local storage (assuming it's stored after login)
     currentUserId = localStorage.getItem('user_id');
     if (currentUserId) {
         userIdInput.value = currentUserId; // Set hidden input
         console.log(`User ID found: ${currentUserId}`);
         await loadAvailableAgents(); // Load agents now that we have user ID
     } else {
         console.error("User ID not found in localStorage. Cannot load agents or chats.");
         showToast("Login session issue: User ID not found.", "error");
         // Optionally redirect to login
     }

     // Define API Base URL (adjust if needed)
     window.API_BASE_URL = window.location.origin; // Assumes backend is at same origin
     console.log(`API Base URL set to: ${window.API_BASE_URL}`);

     disableChatInput(); // Start with input disabled

 });

</script>
{% endblock %}