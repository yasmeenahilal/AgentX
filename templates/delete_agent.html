<!-- templates/delete_agent.html -->
{% extends "base.html" %}

{% block title %}Delete Agent{% endblock %}
{% set active_page = 'delete_agent' %}

{% block content_header %}
    <h1 class="text-2xl font-semibold text-gray-900">Delete Agent</h1>
{% endblock %}

{% block content %}
<div class="bg-white shadow sm:rounded-lg">
    <form id="delete-agent-form" action="/agent/" method="delete"> {# Use JS to modify URL before fetch #}
        <div class="px-4 py-5 sm:p-6">
            <h3 class="text-base font-semibold leading-6 text-gray-900">Identify Agent for Deletion</h3>
            <p class="mt-1 text-sm text-gray-500">Please provide the name of the agent you wish to delete.</p>
            <div class="mt-5 grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-6">
                <div class="sm:col-span-3">
                    <label for="agent_name_delete" class="block text-sm font-medium leading-6 text-gray-900">Agent Name</label>
                    <div class="mt-2">
                        <input type="text" id="agent_name_delete" name="agent_name" required
                               class="form-input block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-rose-600 sm:text-sm sm:leading-6" />
                    </div>
                </div>
                <!-- User ID is now hidden -->
                <input type="hidden" id="user_id_delete" name="user_id" value="{{ user.id }}" class="hidden" />
            </div>
        </div>
        <div class="bg-gray-50 px-4 py-3 sm:px-6 border-t border-gray-200 flex justify-end">
            <button id="submit-delete" type="submit" class="inline-flex justify-center rounded-md bg-red-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition-colors duration-200">
                Delete Agent
            </button>
        </div>
    </form>
</div>

<div id="status-message" class="mt-4 p-4 hidden rounded-md"></div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Check for URL parameters and pre-fill form
    const urlParams = new URLSearchParams(window.location.search);
    const agentParam = urlParams.get('agent');
    
    if (agentParam) {
        document.getElementById('agent_name_delete').value = agentParam;
    }
    
    // Handle form submission
    const form = document.getElementById('delete-agent-form');
    const statusMessage = document.getElementById('status-message');
    
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const agentName = document.getElementById('agent_name_delete').value;
        const userId = document.getElementById('user_id_delete').value;
        
        if (!agentName) {
            showStatus('Please provide the agent name.', 'error');
            return;
        }
        
        const submitButton = document.getElementById('submit-delete');
        submitButton.disabled = true;
        const originalButtonText = submitButton.textContent;
        submitButton.innerHTML = `<svg class="animate-spin -ml-1 mr-2 h-5 w-5 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Deleting...`;
        
        try {
            const response = await fetch('/agent', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    agent_name: agentName,
                    // user_id: userId
                })
            });
            
            const data = await response.json();
            
            if (response.ok) {
                showStatus(`Agent "${agentName}" was successfully deleted.`, 'success');
                form.reset();
            } else {
                showStatus(`Error: ${data.detail || 'Failed to delete agent'}`, 'error');
            }
        } catch (error) {
            console.error('Error deleting agent:', error);
            showStatus(`An error occurred: ${error.message || 'Unknown error'}`, 'error');
        } finally {
            submitButton.disabled = false;
            submitButton.textContent = originalButtonText;
        }
    });
    
    // Function to show status messages
    function showStatus(message, type) {
        statusMessage.textContent = message;
        statusMessage.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800');
        
        if (type === 'success') {
            statusMessage.classList.add('bg-green-100', 'text-green-800');
        } else {
            statusMessage.classList.add('bg-red-100', 'text-red-800');
        }
        
        // Scroll to the message
        statusMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
});
</script>
{% endblock %}