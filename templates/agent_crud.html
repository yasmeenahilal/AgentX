<!-- templates/agent_crud.html -->
{% extends "base.html" %}
{% block title %}Agent Management{% endblock %}
{% set active_page = 'agent_crud' %}

<h1 class="text-2xl font-semibold text-gray-900">Agent Management</h1>


{% block content %}
{# Section for displaying all agents #}

<!-- Add a section for displaying all agents -->
<div class="bg-white shadow sm:rounded-lg mb-6">
    <div class="px-4 py-5 sm:p-6">
        <h3 class="text-base font-semibold leading-6 text-gray-900">All Your Agents</h3>
        <p class="mt-1 text-sm text-gray-500">View all your configured agents.</p>
        
        <!-- User ID is now hidden and automatically filled -->
        <input type="hidden" id="user_id_all" name="user_id_all" value="{{ user.id }}" />
        
        <div class="mt-5">
            <button id="loadAllAgentsBtn" type="button"
                    class="rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600 transition duration-150 ease-in-out">
                Load All Agents
            </button>
        </div>
    </div>
</div>

<!-- All Agents Results Area -->
<div id="allAgentsBox" class="bg-white shadow sm:rounded-lg mt-6 hidden">
    <div class="px-4 py-5 sm:p-6">
        <h3 class="text-base font-semibold leading-6 text-gray-900">Your Agents</h3>
        <div class="mt-4 overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-300">
                <thead>
                    <tr id="agentTableHeader">
                        <!-- Table headers will be inserted by JavaScript -->
                    </tr>
                </thead>
                <tbody id="agentTableBody" class="divide-y divide-gray-200">
                    <!-- Table rows will be inserted by JavaScript -->
                </tbody>
            </table>
        </div>
        <div id="allAgentsError" class="mt-4 text-sm text-red-600 font-medium hidden border-t border-red-200 pt-4"></div>
    </div>
</div>

<!-- Hidden form to store current agent and user ID -->
<form id="listAgentsForm" style="display:none;">
    <input type="text" id="agent_name_list" name="agent_name">
    <input type="text" id="user_id_list" name="user_id" value="{{ user.id }}">
</form>

<!-- Response Area -->
<div id="responseBox" class="bg-white shadow sm:rounded-lg mt-6 hidden">
     <div class="px-4 py-5 sm:p-6">
         <h3 class="text-base font-semibold leading-6 text-gray-900">Agent Details</h3>
         <div id="agentDetailsWrapper" class="mt-4 border-t border-gray-100 pt-4">
             <div id="agentDetails" class="text-sm text-gray-900">
                 <!-- Details populated by JS -->
                  <div class="py-4 sm:py-5 sm:grid sm:grid-cols-3 sm:gap-4">
                     <dt class="font-medium text-gray-500">Loading...</dt>
                     <dd class="mt-1 sm:col-span-2 sm:mt-0 text-gray-500">Please wait.</dd>
                 </div>
             </div>
             <div id="errorMessage" class="mt-4 text-sm text-red-600 font-medium hidden border-t border-red-200 pt-4"></div>
             <div class="mt-5 border-t border-gray-100 pt-5">
                 <button id="openModalBtn" type="button"
                         class="hidden rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600 transition duration-150 ease-in-out">
                     Update Agent
                 </button>
             </div>
         </div>
     </div>
</div>

<!-- Update Agent Modal -->
<div x-data="updateAgentModal()" @open-update-modal.window="open($event.detail)" style="display: none;" x-show="isOpen" x-cloak
    class="relative z-40" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <!-- Overlay -->
    <div x-show="isOpen" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
         x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>

    <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
        <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
            <!-- Modal Panel -->
            <div x-show="isOpen" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95" x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
                 x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100" x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                 @click.outside="close()"
                 class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-2xl">
                 <form id="updateAgentForm" @submit.prevent="submitUpdateForm">
                     <div class="bg-white px-4 pb-4 pt-5 sm:p-6 sm:pb-4">
                         <div class="sm:flex sm:items-start">
                             <div class="mx-auto flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-full bg-indigo-100 sm:mx-0 sm:h-10 sm:w-10">
                                 <svg class="h-6 w-6 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
                                     <path stroke-linecap="round" stroke-linejoin="round" d="M10.343 3.94c.09-.542.56-1.007 1.11-.916l6.07.915a.75.75 0 01.569.908l-1.958 7.754a.75.75 0 01-1.449.088l1.713-6.855-5.086-.763a.75.75 0 01-.61-.97zM9.6 15a.75.75 0 01.75-.75h.008a.75.75 0 01.75.75v.008a.75.75 0 01-.75.75H9.6a.75.75 0 01-.75-.75v-.008zM14.4 11.61a.75.75 0 01.97-.61l6.07.916a.75.75 0 01.569.908l-1.958 7.754a.75.75 0 11-1.449-.088l1.713-6.855-5.086-.763a.75.75 0 01-.61-.97z" />
                                 </svg>
                             </div>
                             <div class="mt-3 text-center sm:ml-4 sm:mt-0 sm:text-left w-full">
                                 <h3 class="text-base font-semibold leading-6 text-gray-900" id="modal-title">Update Agent Settings</h3>
                                 <div class="mt-4 space-y-4 max-h-[60vh] overflow-y-auto pr-2 text-sm">
                                     <!-- Form Fields -->
                                     <input type="hidden" name="agent_name" x-model="agentData.agent_name">
                                     <input type="hidden" name="user_id" x-model="agentData.user_id">

                                      <div class="sm:grid sm:grid-cols-3 sm:items-start sm:gap-4 sm:border-t sm:border-gray-900/10 sm:pt-4">
                                         <label for="update_index_name" class="block font-medium text-gray-900 sm:pt-1.5">Index Name</label>
                                         <div class="mt-2 sm:col-span-2 sm:mt-0">
                                            <input type="text" id="update_index_name" name="index_name" x-model="agentData.index_name"
                                                   class="form-input block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6" />
                                         </div>
                                     </div>
                                     <div class="sm:grid sm:grid-cols-3 sm:items-start sm:gap-4 sm:border-t sm:border-gray-900/10 sm:pt-4">
                                         <label for="update_llm_provider" class="block font-medium text-gray-900 sm:pt-1.5">LLM Provider</label>
                                         <div class="mt-2 sm:col-span-2 sm:mt-0">
                                             <select id="update_llm_provider" name="llm_provider" x-model="agentData.llm_provider"
                                                     class="form-select block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:max-w-xs sm:text-sm sm:leading-6">
                                                 <option value="openai">OpenAI</option>
                                                 <option value="huggingface">Hugging Face</option>
                                                 <option value="gemini">Gemini</option>
                                             </select>
                                         </div>
                                     </div>
                                     <div class="sm:grid sm:grid-cols-3 sm:items-start sm:gap-4 sm:border-t sm:border-gray-900/10 sm:pt-4">
                                         <label for="update_llm_model_name" class="block font-medium text-gray-900 sm:pt-1.5">LLM Model Name</label>
                                         <div class="mt-2 sm:col-span-2 sm:mt-0">
                                             <!-- Text input for custom model names -->
                                             <input type="text" id="update_llm_model_name_text" name="llm_model_name" x-model="agentData.llm_model_name"
                                                class="form-input block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6" />
                                             
                                             <!-- Select input for Hugging Face models (initially hidden) -->
                                             <select id="update_llm_model_name_huggingface" name="llm_model_name" x-model="agentData.llm_model_name"
                                                class="form-select block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6 hidden">
                                                <optgroup label="Qwen Models">
                                                    <option value="Qwen/Qwen2-1.5B-Instruct">Qwen 1.5B Instruct</option>
                                                    <option value="Qwen/Qwen-7B-Chat">Qwen 7B Chat</option>
                                                </optgroup>
                                                <optgroup label="Mistral Models">
                                                    <option value="mistralai/Mistral-7B-Instruct-v0.1">Mistral 7B Instruct v0.1</option>
                                                </optgroup>
                                                <optgroup label="Llama Models">
                                                    <option value="meta-llama/Llama-2-13b-chat-hf">Llama 2 13B Chat</option>
                                                </optgroup>
                                                <optgroup label="Flan-T5 Models">
                                                    <option value="google/flan-t5-xxl">Flan-T5 XXL</option>
                                                </optgroup>
                                                <optgroup label="BART Models">
                                                    <option value="facebook/bart-large">BART Large</option>
                                                </optgroup>
                                                <optgroup label="BLOOM Models">
                                                    <option value="bigscience/bloom-7b1">BLOOM 7B1</option>
                                                </optgroup>
                                                <optgroup label="StableLM Models">
                                                    <option value="stabilityai/stablelm-tuned-alpha-7b">StableLM 7B Tuned Alpha</option>
                                                </optgroup>
                                                <optgroup label="TinyLlama Models">
                                                    <option value="TinyLlama/TinyLlama-1.1B-Chat-v1.0">TinyLlama 1.1B Chat</option>
                                                </optgroup>
                                            </select>
                                             
                                             <!-- Select input for Gemini models (initially hidden) -->
                                             <select id="update_llm_model_name_select" name="llm_model_name" x-model="agentData.llm_model_name"
                                                class="form-select block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6 hidden">
                                                <option value="gemini-2.0-flash">Gemini 2.0 Flash</option>
                                                <option value="gemini-2.5-flash-preview-04-17">Gemini 2.5 Flash Preview (04-17)</option>
                                                <option value="gemini-2.5-pro-preview-03-25">Gemini 2.5 Pro Preview (03-25)</option>
                                                <option value="gemini-2.0-flash-lite">Gemini 2.0 Flash Lite</option>
                                                <option value="gemini-1.5-flash">Gemini 1.5 Flash</option>
                                                <option value="gemini-1.5-flash-8b">Gemini 1.5 Flash 8B</option>
                                                <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
                                                <option value="gemini-1.5-pro-vision">Gemini 1.5 Pro Vision</option>
                                            </select>
                                         </div>
                                     </div>
                                     <div class="sm:grid sm:grid-cols-3 sm:items-start sm:gap-4 sm:border-t sm:border-gray-900/10 sm:pt-4">
                                         <label for="update_llm_api_key" class="block font-medium text-gray-900 sm:pt-1.5">LLM API Key</label>
                                         <div class="mt-2 sm:col-span-2 sm:mt-0">
                                             <input type="password" id="update_llm_api_key" name="llm_api_key" placeholder="Leave blank to keep current"
                                                    class="form-input block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6" />
                                         </div>
                                     </div>
                                      <div class="sm:grid sm:grid-cols-3 sm:items-start sm:gap-4 sm:border-t sm:border-gray-900/10 sm:pt-4">
                                          <label for="update_embeddings_model" class="block font-medium text-gray-900 sm:pt-1.5">Embeddings Model</label>
                                          <div class="mt-2 sm:col-span-2 sm:mt-0">
                                              <input type="text" id="update_embeddings_model" name="embeddings_model" x-model="agentData.embedding"
                                                     class="form-input block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6" />
                                          </div>
                                     </div>
                                      <div class="sm:grid sm:grid-cols-3 sm:items-start sm:gap-4 sm:border-t sm:border-gray-900/10 sm:pt-4">
                                          <label for="update_prompt_template" class="block font-medium text-gray-900 sm:pt-1.5">System Prompt</label>
                                          <div class="mt-2 sm:col-span-2 sm:mt-0">
                                              <textarea id="update_prompt_template" name="prompt_template" rows="5" x-model="agentData.prompt_template"
                                                        class="form-textarea block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6"></textarea>
                                          </div>
                                     </div>
                                     <!-- End Form Fields -->
                                     <div id="updateMessage" class="mt-4 text-green-600 font-medium text-sm hidden border-t border-gray-900/10 pt-4"></div>
                                     <div id="updateError" class="mt-4 text-red-600 font-medium text-sm hidden border-t border-gray-900/10 pt-4"></div>
                                 </div>
                             </div>
                         </div>
                     </div>
                     <div class="bg-gray-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6">
                         <button type="submit"
                                 class="inline-flex w-full justify-center rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 sm:ml-3 sm:w-auto">
                             Save Changes
                         </button>
                         <button type="button" @click="close()"
                                 class="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:mt-0 sm:w-auto">
                             Cancel
                         </button>
                     </div>
                 </form>
            </div>
        </div>
    </div>
</div>

{# Toast Notification Container (from base.html) #}
<div id="toast-container" aria-live="assertive" aria-atomic="true" class="fixed inset-0 flex items-end px-4 py-6 pointer-events-none sm:items-start sm:p-6 z-50">
  <div class="flex w-full flex-col items-center space-y-4 sm:items-end">
    <!-- Toast notifications will be appended here -->
  </div>
</div>


<script>
 // --- Toast Function --- (Assume it's defined globally or imported)
 function showToast(message, type = 'success') { /* ... full implementation ... */ }

 // --- Alpine.js Data for Modal --- 
 document.addEventListener('alpine:init', () => {
    Alpine.data('updateAgentModal', () => ({
        isOpen: false,
        agentData: {
            agent_name: '',
            user_id: '',
            index_name: '',
            llm_provider: '',
            llm_model_name: '',
            llm_api_key: '',
            embedding: '',
            prompt_template: ''
        },

        open(detail) {
            // Initialize agentData with empty values
            this.agentData = {
                agent_name: '',
                user_id: '',
                index_name: '',
                llm_provider: '',
                llm_model_name: '',
                llm_api_key: '',
                embedding: '',
                prompt_template: ''
            };
            
            // Update with provided data
            if (detail) {
                this.agentData = {
                    ...this.agentData,
                    ...detail
                };
            }
            
            // Clear previous messages
            document.getElementById('updateMessage').classList.add('hidden');
            document.getElementById('updateError').classList.add('hidden');
            this.isOpen = true;
        },
        
        close() {
            this.isOpen = false;
            // Reset form data
            this.agentData = {
                agent_name: '',
                user_id: '',
                index_name: '',
                llm_provider: '',
                llm_model_name: '',
                llm_api_key: '',
                embedding: '',
                prompt_template: ''
            };
        },
        
        async submitUpdateForm() {
            const form = document.getElementById('updateAgentForm');
            const submitButton = form.querySelector('button[type="submit"]');
            const updateMessage = document.getElementById('updateMessage');
            const updateError = document.getElementById('updateError');

            const originalButtonText = submitButton.textContent;
            submitButton.disabled = true;
            submitButton.innerHTML = `<svg class="animate-spin -ml-1 mr-2 h-5 w-5 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Saving...`;

            updateMessage.classList.add('hidden');
            updateError.classList.add('hidden');

            // Create update data object
            const updateData = {
                agent_name: this.agentData.agent_name,
                user_id: this.agentData.user_id
            };

            // Only include fields that have been modified
            if (this.agentData.index_name) updateData.index_name = this.agentData.index_name;
            if (this.agentData.llm_provider) updateData.llm_provider = this.agentData.llm_provider;
            if (this.agentData.llm_model_name) updateData.llm_model_name = this.agentData.llm_model_name;
            if (this.agentData.llm_api_key) updateData.llm_api_key = this.agentData.llm_api_key;
            if (this.agentData.embedding) updateData.embeddings_model = this.agentData.embedding;
            if (this.agentData.prompt_template) updateData.prompt_template = this.agentData.prompt_template;

            try {
                const apiUrl = `/api/user/agents/${this.agentData.user_id}/${this.agentData.agent_name}`;
                console.log('Sending update request to:', apiUrl);
                console.log('Request data:', JSON.stringify(updateData, null, 2));
                
                const res = await fetch(apiUrl, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                    body: JSON.stringify(updateData)
                });
                const data = await res.json().catch(() => ({}));

                if (res.ok) {
                    updateMessage.textContent = data.message || 'Agent updated successfully!';
                    updateMessage.classList.remove('hidden');
                    setTimeout(() => { this.close(); }, 1500); // Close modal after success
                    // Refresh the main agent details view
                    document.getElementById('listAgentsForm').dispatchEvent(new Event('submit'));
                } else {
                    updateError.textContent = data.detail || data.message || `Update failed (Status: ${res.status}).`;
                    updateError.classList.remove('hidden');
                }
            } catch (err) {
                console.error("Update error:", err);
                updateError.textContent = 'Failed to update agent. Check console or network tab.';
                updateError.classList.remove('hidden');
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = originalButtonText;
            }
        }
    }))
})

 // --- Fetch Details Logic --- 
 document.addEventListener('DOMContentLoaded', function () {
    const listForm = document.getElementById('listAgentsForm');
    const responseBox = document.getElementById('responseBox');
    const agentDetailsContainer = document.getElementById('agentDetails');
    const errorMessage = document.getElementById('errorMessage');
    const openModalBtn = document.getElementById('openModalBtn');

    if (!listForm) return; // Exit if form not found

    // Function to fetch agent details
    async function fetchAgentDetails(userId, agentName) {
        responseBox.classList.add('hidden'); // Hide until response
        errorMessage.classList.add('hidden');
        openModalBtn.classList.add('hidden');
        agentDetailsContainer.innerHTML = '<p class="text-sm text-gray-500">Loading details...</p>'; // Loading state

        try {
             const apiUrl = `/agent/${agentName}/`; // API endpoint
             console.log('Fetching agent details from:', apiUrl);
             const res = await fetch(apiUrl);
             const data = await res.json().catch(() => null); // Handle non-JSON response

             responseBox.classList.remove('hidden'); // Show response box

             if (res.ok && data) {
                console.log('Agent details received:', data);
                // Format details using definition list (dl, dt, dd)
                let detailsHtml = '<dl class="divide-y divide-gray-100">';
                
                // Add each property to the display, skipping sensitive data
                for (const [key, value] of Object.entries(data)) {
                    // Skip internal properties and sensitive data
                    if (['database_columns', 'columns', 'llm_api_key'].includes(key)) continue;
                    
                    // Format the value based on type
                    let formattedValue = value;
                    
                    if (key === 'prompt_template') {
                        formattedValue = `<pre class="bg-gray-50 p-2 rounded text-xs whitespace-pre-wrap break-words font-mono">${value}</pre>`;
                    } else if (Array.isArray(value)) {
                        formattedValue = value.join(', ');
                    } else if (value === null || value === undefined) {
                        formattedValue = 'N/A';
                    }
                    
                    detailsHtml += `<div class="py-4 sm:grid sm:grid-cols-3 sm:gap-4 sm:py-5">
                        <dt class="text-sm font-medium text-gray-500">${key.replace(/_/g, ' ').toUpperCase()}</dt>
                        <dd class="mt-1 text-sm leading-6 text-gray-700 sm:col-span-2 sm:mt-0">${formattedValue}</dd>
                    </div>`;
                }
                
                // If there are database columns, display them
                if (data.database_columns && data.database_columns.length > 0) {
                    detailsHtml += `<div class="py-4 sm:grid sm:grid-cols-3 sm:gap-4 sm:py-5">
                        <dt class="text-sm font-medium text-gray-500">DATABASE COLUMNS</dt>
                        <dd class="mt-1 text-sm leading-6 text-gray-700 sm:col-span-2 sm:mt-0">
                            ${data.database_columns.join(', ')}
                        </dd>
                    </div>`;
                }
                
                detailsHtml += '</dl>';
                agentDetailsContainer.innerHTML = detailsHtml;
                
                // Show the update button
                openModalBtn.classList.remove('hidden');
                
                // Store the agent data for the update form
                window.agentData = {
                    agent_name: data.agent_name,
                    user_id: data.user_id,
                    index_name: data.index_name,
                    llm_provider: data.llm_provider,
                    llm_model_name: data.llm_model_name,
                    llm_api_key: data.llm_api_key,
                    prompt_template: data.prompt_template,
                    embedding: data.embedding
                };
                
            } else {
                errorMessage.textContent = data?.detail || `Could not fetch details for Agent "${agentName}"`;
                errorMessage.classList.remove('hidden');
                agentDetailsContainer.innerHTML = ''; // Clear loading state
            }
        } catch (error) {
            console.error('Error:', error);
            errorMessage.textContent = `Error: ${error.message || 'Unknown error'}`;
            errorMessage.classList.remove('hidden');
            agentDetailsContainer.innerHTML = ''; // Clear loading state
        }
    }

    // Handle form submission (for hidden form)
    listForm.addEventListener('submit', function (e) {
        e.preventDefault();
        const agentName = document.getElementById('agent_name_list').value;
        const userId = document.getElementById('user_id_list').value;
        fetchAgentDetails(userId, agentName);
    });

     // Event listener for the Update Agent button (triggers Alpine modal)
     openModalBtn.addEventListener('click', () => {
        // Get the data stored when fetch was successful
        window.dispatchEvent(new CustomEvent('get-agent-data-for-modal')); // Ask Alpine component for data
    });

     // Store the fetched data when event is dispatched
     let agentDataForModal = {};
     window.addEventListener('update-agent-data', (event) => {
        agentDataForModal = event.detail;
     });

     // Provide data to Alpine when requested
     window.addEventListener('get-agent-data-for-modal', () => {
         window.dispatchEvent(new CustomEvent('open-update-modal', { detail: window.agentData }));
     });

 });

// Add this JavaScript to handle the new API endpoint
document.addEventListener('DOMContentLoaded', function() {
    const loadAllAgentsBtn = document.getElementById('loadAllAgentsBtn');
    const userIdAllInput = document.getElementById('user_id_all');
    const allAgentsBox = document.getElementById('allAgentsBox');
    const agentTableHeader = document.getElementById('agentTableHeader');
    const agentTableBody = document.getElementById('agentTableBody');
    const allAgentsError = document.getElementById('allAgentsError');
    
    // Auto-load agents when page loads
    if (loadAllAgentsBtn && userIdAllInput.value) {
        loadAllAgentsBtn.click();
    }
    
    if (loadAllAgentsBtn) {
        loadAllAgentsBtn.addEventListener('click', async function() {
            const userId = userIdAllInput.value;
            if (!userId) {
                allAgentsError.textContent = 'User ID is not available';
                allAgentsError.classList.remove('hidden');
                return;
            }
            
            // Clear previous error
            allAgentsError.classList.add('hidden');
            
            // Show loading state
            loadAllAgentsBtn.disabled = true;
            const originalButtonText = loadAllAgentsBtn.textContent;
            loadAllAgentsBtn.innerHTML = `<svg class="animate-spin -ml-1 mr-2 h-5 w-5 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Loading...`;
            
            try {
                // Get the current user's ID from the auth system
                const response = await fetch(`/agent/list_agents`);
                const data = await response.json();
                
                allAgentsBox.classList.remove('hidden');
                
                if (data.agents && data.agents.length > 0) {
                    // Get all possible keys from all agents
                    const allKeys = new Set();
                    data.agents.forEach(agent => {
                        Object.keys(agent).forEach(key => allKeys.add(key));
                    });
                    
                    // Remove 'user_id' from displayed columns if present
                    allKeys.delete('user_id');
                    
                    // Filter other keys you might want to hide
                    const keysToShow = Array.from(allKeys).filter(key => 
                        !['id'].includes(key)
                    );
                    
                    // Create the table header
                    agentTableHeader.innerHTML = '';
                    keysToShow.forEach(key => {
                        const th = document.createElement('th');
                        th.className = 'px-3 py-3.5 text-left text-sm font-semibold text-gray-900 capitalize';
                        th.textContent = key.replace(/_/g, ' ');
                        agentTableHeader.appendChild(th);
                    });
                    
                    // Add an Actions column
                    const actionsHeader = document.createElement('th');
                    actionsHeader.className = 'px-3 py-3.5 text-right text-sm font-semibold text-gray-900';
                    actionsHeader.textContent = 'Actions';
                    agentTableHeader.appendChild(actionsHeader);
                    
                    // Create table rows
                    agentTableBody.innerHTML = '';
                    data.agents.forEach(agent => {
                        const row = document.createElement('tr');
                        
                        keysToShow.forEach(key => {
                            const td = document.createElement('td');
                            td.className = 'whitespace px-3 py-4 text-sm text-gray-500';
                            
                            // Format/handle special values
                            if (key === 'agent_name') {
                                const strong = document.createElement('strong');
                                strong.className = 'font-medium text-gray-900';
                                strong.textContent = agent[key] || '';
                                td.appendChild(strong);
                            } else {
                                td.textContent = agent[key] || '';
                            }
                            
                            row.appendChild(td);
                        });
                        
                        // Add action buttons
                        const actionsTd = document.createElement('td');
                        actionsTd.className = 'whitespace-nowrap px-3 py-4 text-sm text-gray-500 text-right';
                        
                        const actionButtonsContainer = document.createElement('div');
                        actionButtonsContainer.className = 'flex justify-end space-x-2';
                        
                        // View details button
                        const viewBtn = document.createElement('button');
                        viewBtn.type = 'button';
                        viewBtn.className = 'view-agent-btn text-indigo-600 hover:text-indigo-900 px-2 py-1 rounded hover:bg-indigo-50';
                        viewBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>';
                        viewBtn.dataset.agent = agent.agent_name;
                        viewBtn.dataset.user = userId;
                        viewBtn.title = 'View Details';
                        
                        // Delete button
                        const deleteBtn = document.createElement('button');
                        deleteBtn.type = 'button';
                        deleteBtn.className = 'delete-agent-btn text-red-600 hover:text-red-900 px-2 py-1 rounded hover:bg-red-50';
                        deleteBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" /></svg>';
                        deleteBtn.dataset.agent = agent.agent_name;
                        deleteBtn.dataset.user = userId;
                        deleteBtn.title = 'Delete Agent';
                        
                        actionButtonsContainer.appendChild(viewBtn);
                        actionButtonsContainer.appendChild(deleteBtn);
                        actionsTd.appendChild(actionButtonsContainer);
                        row.appendChild(actionsTd);
                        
                        agentTableBody.appendChild(row);
                    });
                    
                    // Add event listeners to the view buttons
                    document.querySelectorAll('.view-agent-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            document.getElementById('agent_name_list').value = this.dataset.agent;
                            document.getElementById('user_id_list').value = this.dataset.user;
                            document.getElementById('listAgentsForm').dispatchEvent(new Event('submit'));
                        });
                    });
                    
                    // Add event listeners to the delete buttons
                    document.querySelectorAll('.delete-agent-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            if (confirm(`Are you sure you want to delete agent "${this.dataset.agent}"?`)) {
                                // Redirect to delete page with prefilled values
                                window.location.href = `/html/delete_agent?agent=${this.dataset.agent}`;
                            }
                        });
                    });
                } else {
                    allAgentsError.textContent = data.detail || 'No agents found for this user';
                    allAgentsError.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error loading agents:', error);
                allAgentsError.textContent = 'Failed to load agents: ' + (error.message || 'Unknown error');
                allAgentsError.classList.remove('hidden');
            } finally {
                loadAllAgentsBtn.disabled = false;
                loadAllAgentsBtn.textContent = originalButtonText;
            }
        });
    }
});

document.addEventListener('DOMContentLoaded', function() {
    const updateLlmProvider = document.getElementById('update_llm_provider');
    const updateLlmModelNameText = document.getElementById('update_llm_model_name_text');
    const updateLlmModelNameHuggingFace = document.getElementById('update_llm_model_name_huggingface');
    const updateLlmModelNameSelect = document.getElementById('update_llm_model_name_select');

    // Function to toggle between text and select inputs based on provider
    function updateModelNameInput() {
        const provider = updateLlmProvider.value;
        const isGemini = provider === 'gemini';
        const isHuggingFace = provider === 'huggingface';
        
        // Hide all inputs first
        updateLlmModelNameText.classList.add('hidden');
        updateLlmModelNameHuggingFace.classList.add('hidden');
        updateLlmModelNameSelect.classList.add('hidden');
        
        // Show the appropriate input
        if (isGemini) {
            updateLlmModelNameSelect.classList.remove('hidden');
            updateLlmModelNameSelect.setAttribute('name', 'llm_model_name');
            updateLlmModelNameText.removeAttribute('name');
            updateLlmModelNameHuggingFace.removeAttribute('name');
        } else if (isHuggingFace) {
            updateLlmModelNameHuggingFace.classList.remove('hidden');
            updateLlmModelNameHuggingFace.setAttribute('name', 'llm_model_name');
            updateLlmModelNameText.removeAttribute('name');
            updateLlmModelNameSelect.removeAttribute('name');
        } else {
            updateLlmModelNameText.classList.remove('hidden');
            updateLlmModelNameText.setAttribute('name', 'llm_model_name');
            updateLlmModelNameHuggingFace.removeAttribute('name');
            updateLlmModelNameSelect.removeAttribute('name');
        }
    }

    // Add event listener for provider changes
    updateLlmProvider.addEventListener('change', updateModelNameInput);

    // Initial setup
    updateModelNameInput();
});
</script>
{% endblock %} 