<!-- templates/insert_data_to_index.html -->
{% extends "base.html" %}
{% block title %}Upload Data to Index{% endblock %}
{% set active_page = 'upload' %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <h1 class="text-2xl font-semibold text-gray-900 mb-4">Upload Data to Vector Index</h1>

    <!-- Error/Success Alert Box -->
    <div id="alert-box" class="mb-6 rounded-md p-4 hidden">
        <div class="flex items-center">
            <div id="alert-icon" class="flex-shrink-0"></div>
            <div class="ml-3">
                <h3 id="alert-title" class="text-sm font-medium"></h3>
                <div id="alert-message" class="mt-2 text-sm"></div>
            </div>
            <div class="ml-auto pl-3">
                <div class="-mx-1.5 -my-1.5">
                    <button type="button" onclick="dismissAlert()" class="inline-flex rounded-md p-1.5 focus:outline-none focus:ring-2 focus:ring-offset-2">
                        <span class="sr-only">Dismiss</span>
                        <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <form id="uploadForm" class="mt-4">
        <div class="shadow sm:overflow-hidden sm:rounded-md">
            <div class="space-y-6 bg-white px-4 py-5 sm:p-6">

                <!-- Section 1: Index Details -->
                <div>
                    <h3 class="text-base font-semibold leading-6 text-gray-900">Index & File Details</h3>
                    <p class="mt-1 text-sm text-gray-500">Provide the target index, user identifier, and the document to upload.</p>
                </div>
                <div class="grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-6">
                    <!-- User ID is now hidden and populated from the authenticated user -->
                    <input type="hidden" id="user_id_upload" name="user_id" />

                    <div class="sm:col-span-3">
                        <label for="index_name_upload" class="block text-sm font-medium text-gray-700 ">Index Name</label>
                        <input type="text" id="index_name_upload" name="index_name" required
                            class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm h-9 px-2" />
                        <p class="mt-2 text-xs text-gray-500">The target index for the uploaded data.</p>
                    </div>

                    <div class="sm:col-span-3">
                        <label for="embedding_upload" class="block text-sm font-medium text-gray-700 ">Embedding Model</label>
                        <select id="embedding_upload" name="embedding" required
                            class="form-select mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm h-9 px-2">
                            <option value="sentence-transformers/all-mpnet-base-v2" selected>sentence-transformers/all-mpnet-base-v2</option>
                            <option value="openai">OpenAI</option>
                            <option value="huggingface">HuggingFace</option>
                            <option value="cohere">Cohere</option>
                        </select>
                        <p class="mt-2 text-xs text-gray-500">Model used for generating embeddings.</p>
                    </div>

                    <div class="sm:col-span-3">
                        <label for="file_upload" class="block text-sm font-medium text-gray-700 ">Document File</label>
                        <input type="file" id="file_upload" name="file" accept=".pdf,.txt,.md" required
                            class="block w-full mt-1 text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100" />
                        <p class="mt-2 text-xs text-gray-500">Supports PDF, TXT, Markdown files.</p>
                    </div>
                </div>

                <!-- Section 2: Vector DB Config -->
                <div class="border-t border-gray-200 pt-6">
                    <h3 class="text-base font-semibold text-gray-900">Vector Database Configuration</h3>
                    <p class="mt-1 text-sm text-gray-500">Select the type of vector database and provide specific settings if required.</p>
                </div>

                <div class="grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-6">
                    <div class="sm:col-span-3">
                        <label for="vectordb" class="block text-sm font-medium text-gray-700">Vector DB Type</label>
                        <select name="vectordb" id="vectordb" required
                            class="form-select mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm h-9 px-2 h-8">
                            <option value="" disabled selected>-- Select DB Type --</option>
                            <option value="Pinecone">Pinecone</option>
                            <option value="FAISS">FAISS (Local)</option>
                        </select>
                    </div>
                </div>

                <!-- Pinecone Specific Fields -->
                <div id="Pinecone-fields" class="hidden mt-6 border border-indigo-200 bg-indigo-50 p-4 rounded-md">
                    <h4 class="text-sm font-medium text-indigo-800 mb-4">Pinecone Settings</h4>
                    <div class="grid grid-cols-1 gap-y-4 gap-x-4 sm:grid-cols-6">
                        <div class="sm:col-span-3">
                            <label for="pinecone_api_key" class="block text-xs font-medium text-gray-700">API Key</label>
                            <input type="password" id="pinecone_api_key" name="pinecone_api_key"
                                class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-xs h-8 px-2" />
                        </div>

                        <div class="sm:col-span-3">
                            <label for="pinecone_metric" class="block text-xs font-medium text-gray-700">Metric</label>
                            <input type="text" id="pinecone_metric" name="metric" value="cosine"
                                class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-xs h-8 px-2" />
                        </div>

                        <div class="sm:col-span-2">
                            <label for="pinecone_cloud" class="block text-xs font-medium text-gray-700">Cloud</label>
                            <input type="text" id="pinecone_cloud" name="cloud" value="aws"
                                class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-xs h-8 px-2" />
                        </div>

                        <div class="sm:col-span-2">
                            <label for="pinecone_region" class="block text-xs font-medium text-gray-700">Region</label>
                            <input type="text" id="pinecone_region" name="region" value="us-east-1"
                                class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-xs h-8 px-2" />
                        </div>

                        <div class="sm:col-span-2">
                            <label for="pinecone_dimension" class="block text-xs font-medium text-gray-700">Dimension</label>
                            <input type="number" id="pinecone_dimension" name="dimension" value="768"
                                class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-xs h-8 px-2" />
                            <p class="mt-1 text-xs text-gray-500">Must match embedding model output.</p>
                        </div>
                    </div>
                </div>

                <!-- FAISS Fields -->
                <div id="FAISS-fields" class="hidden mt-6 border border-green-200 bg-green-50 p-4 rounded-md">
                    <h4 class="text-sm font-medium text-green-800 mb-2">FAISS Settings</h4>
                    <p class="text-xs text-gray-600">FAISS will be saved locally. No extra config required.</p>
                </div>
            </div>

            <!-- Action Button -->
            <div class="bg-gray-50 px-4 py-3 text-right sm:px-6">
                <button type="submit" id="submit-button"
                    class="inline-flex justify-center rounded-md bg-indigo-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                    Upload
                </button>
            </div>
        </div>
    </form>
</div>

<script>
    // Show/hide DB specific fields
    document.getElementById('vectordb').addEventListener('change', function () {
        const selected = this.value;
        document.getElementById('Pinecone-fields').classList.toggle('hidden', selected !== 'Pinecone');
        document.getElementById('FAISS-fields').classList.toggle('hidden', selected !== 'FAISS');
    });

    // Set user ID from localStorage
    document.addEventListener('DOMContentLoaded', function() {
        // Get user ID from localStorage
        const userId = localStorage.getItem('user_id');
        if (userId) {
            document.getElementById('user_id_upload').value = userId;
        }
    });

    // Handle form submission with proper error handling
    document.getElementById('uploadForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // Show loading state
        const submitButton = document.getElementById('submit-button');
        const originalButtonText = submitButton.textContent;
        submitButton.disabled = true;
        submitButton.innerHTML = `
            <svg class="animate-spin -ml-1 mr-2 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Uploading...
        `;
        
        // Get form data
        const formData = new FormData(this);
        const vectordbType = document.getElementById('vectordb').value;
        
        // Validate form data
        if (!formData.get('index_name') || !formData.get('file') || !vectordbType) {
            showAlert('error', 'Missing Fields', 'Please fill out all required fields.');
            resetButton();
            return;
        }
        
        if (vectordbType === 'Pinecone' && !formData.get('pinecone_api_key')) {
            showAlert('error', 'Missing API Key', 'Pinecone API Key is required.');
            resetButton();
            return;
        }
        
        try {
            const response = await fetch('/index/insert_data_to_index', {
                method: 'POST',
                body: formData,
                credentials: 'include'
            });
            
            // Try to parse the response as JSON
            let data;
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
                data = await response.json();
            } else {
                const text = await response.text();
                // Try to extract error from text if it's JSON-like
                try {
                    data = JSON.parse(text);
                } catch (e) {
                    data = { detail: text || 'Unknown error occurred' };
                }
            }
            
            if (response.ok) {
                // Success case
                showAlert('success', 'Upload Successful', 'Your data has been successfully uploaded to the index.');
                this.reset();
                document.getElementById('Pinecone-fields').classList.add('hidden');
                document.getElementById('FAISS-fields').classList.add('hidden');
            } else {
                // Error handling for different scenarios
                let errorMessage = data.detail || 'An unknown error occurred';
                
                // Provide user-friendly messages based on error content
                if (errorMessage.includes('EmbeddingModel')) {
                    errorMessage = 'The embedding model you selected is not valid. Please choose a different embedding model.';
                } else if (errorMessage.includes('already exists')) {
                    errorMessage = 'An index with this name already exists for your account. Please use a different name or update the existing index.';
                } else if (errorMessage.includes('Failed to create FAISS database')) {
                    errorMessage = 'There was a problem creating the FAISS database. Please check your embedding model selection and try again.';
                }
                
                showAlert('error', 'Upload Failed', errorMessage);
            }
        } catch (error) {
            console.error('Error uploading data:', error);
            showAlert('error', 'Connection Error', 'Could not connect to the server. Please check your connection and try again.');
        } finally {
            resetButton();
        }
        
        function resetButton() {
            submitButton.disabled = false;
            submitButton.textContent = originalButtonText;
        }
    });
    
    // Function to show alert messages
    function showAlert(type, title, message) {
        const alertBox = document.getElementById('alert-box');
        const alertTitle = document.getElementById('alert-title');
        const alertMessage = document.getElementById('alert-message');
        const alertIcon = document.getElementById('alert-icon');
        
        // Set content
        alertTitle.textContent = title;
        alertMessage.textContent = message;
        
        // Reset classes
        alertBox.className = 'mb-6 rounded-md p-4';
        alertIcon.innerHTML = '';
        
        // Apply styling based on type
        if (type === 'success') {
            alertBox.classList.add('bg-green-50');
            alertTitle.className = 'text-sm font-medium text-green-800';
            alertMessage.className = 'mt-2 text-sm text-green-700';
            alertIcon.innerHTML = `
                <svg class="h-5 w-5 text-green-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                </svg>
            `;
        } else {
            alertBox.classList.add('bg-red-50');
            alertTitle.className = 'text-sm font-medium text-red-800';
            alertMessage.className = 'mt-2 text-sm text-red-700';
            alertIcon.innerHTML = `
                <svg class="h-5 w-5 text-red-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                </svg>
            `;
        }
        
        // Show the alert
        alertBox.classList.remove('hidden');
        
        // Scroll to top to ensure alert is visible
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
    // Function to dismiss alert
    function dismissAlert() {
        document.getElementById('alert-box').classList.add('hidden');
    }
</script>
{% endblock %}
